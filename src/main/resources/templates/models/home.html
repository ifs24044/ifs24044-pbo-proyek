<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/base}"
  lang="id"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Restaurant Menu Management</title>
  </head>
  <body>
    <div layout:fragment="content" class="mt-3">
      <div class="card">
        <div class="card-header d-flex">
          <div class="flex-fill">
            <h3>üçΩÔ∏è Halo, [[${auth.name}]]</h3>
            <p class="text-muted mb-0">Kelola menu restoran Anda</p>
          </div>
          <div>
            <a th:href="@{/auth/logout}" class="btn btn-sm btn-danger">Keluar</a>
          </div>
        </div>
        <div class="card-body">
          <!-- Header dengan tombol dan pencarian -->
          <div class="d-flex mb-3 align-items-center">
            <div class="flex-fill">
              <h3>üìã Daftar Menu</h3>
            </div>
            <div class="d-flex gap-2">
              <a th:href="@{/menu-items/chart}" class="btn btn-info">
                üìä Lihat Statistik
              </a>
              <button
                class="btn btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#addMenuModal"
              >
                ‚ûï Tambah Menu
              </button>
            </div>
          </div>

          <!-- Filter kategori -->
          <div class="mb-3">
            <div class="btn-group" role="group">
              <a th:href="@{/}" class="btn btn-outline-primary">Semua</a>
              <a th:href="@{/(category='Appetizer')}" class="btn btn-outline-primary">Appetizer</a>
              <a th:href="@{/(category='Main Course')}" class="btn btn-outline-primary">Main Course</a>
              <a th:href="@{/(category='Dessert')}" class="btn btn-outline-primary">Dessert</a>
              <a th:href="@{/(category='Beverage')}" class="btn btn-outline-primary">Beverage</a>
            </div>
          </div>

          <!-- Tabel menu -->
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-light">
                <tr>
                  <th>No</th>
                  <th>Gambar</th>
                  <th>Nama Menu</th>
                  <th>Kategori</th>
                  <th>Harga</th>
                  <th>Waktu Siap</th>
                  <th>Kalori</th>
                  <th>Status</th>
                  <th>Tindakan</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="menu, status : ${menuItems}">
                  <td th:text="${status.index + 1}"></td>
                  <td>
                    <img
                      th:if="${menu.imageUrl != null}"
                      th:src="@{/menu-items/image/{filename}(filename=${menu.imageUrl})}"
                      alt="Menu Image"
                      class="img-thumbnail"
                      style="width: 60px; height: 60px; object-fit: cover;"
                    />
                    <div
                      th:unless="${menu.imageUrl != null}"
                      class="bg-secondary d-flex align-items-center justify-content-center"
                      style="width: 60px; height: 60px; border-radius: 5px;"
                    >
                      <span class="text-white">üçΩÔ∏è</span>
                    </div>
                  </td>
                  <td>
                    <strong th:text="${menu.name}"></strong><br/>
                    <small class="text-muted" th:text="${menu.description}"></small>
                  </td>
                  <td>
                    <span class="badge bg-info" th:text="${menu.category}"></span>
                  </td>
                  <td>
                    <strong th:text="'Rp ' + ${#numbers.formatDecimal(menu.price, 0, 'COMMA', 0, 'POINT')}"></strong>
                  </td>
                  <td th:text="${menu.preparationTime} + ' menit'"></td>
                  <td>
                    <span th:if="${menu.calories != null}" th:text="${menu.calories} + ' kcal'"></span>
                    <span th:unless="${menu.calories != null}" class="text-muted">-</span>
                  </td>
                  <td>
                    <span th:if="${menu.isAvailable}" class="badge bg-success">Tersedia</span>
                    <span th:unless="${menu.isAvailable}" class="badge bg-danger">Tidak Tersedia</span>
                  </td>
                  <td>
                    <div class="btn-group" role="group">
                      <a
                        th:href="@{/menu-items/{menuId}(menuId=${menu.id})}"
                        class="btn btn-sm btn-info"
                        title="Detail"
                      >
                        üëÅÔ∏è
                      </a>
                      <button
                        th:id="|editMenuButton_${menu.id}|"
                        th:attr="onclick=|prepareEditMenu('${menu.id}', '${menu.name}', '${menu.category}', ${menu.price}, '${menu.description}', ${menu.preparationTime}, ${menu.calories}, ${menu.isAvailable})|"
                        class="btn btn-sm btn-warning"
                        title="Edit"
                      >
                        ‚úèÔ∏è
                      </button>
                      <button
                        th:id="|deleteMenuButton_${menu.id}|"
                        th:attr="onclick=|prepareDeleteMenu('${menu.id}', '${menu.name}')|"
                        class="btn btn-sm btn-danger"
                        title="Hapus"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  </td>
                </tr>
                <tr th:if="${#lists.isEmpty(menuItems)}">
                  <td colspan="9" class="text-center py-4">
                    <div class="text-muted">
                      <h5>üçΩÔ∏è Belum ada menu yang tersedia</h5>
                      <p>Klik tombol "Tambah Menu" untuk menambahkan menu baru</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Modals -->
      <div th:replace="~{pages/menu-items/add :: addMenuModal}"></div>
      <div th:replace="~{pages/menu-items/edit :: editMenuModal}"></div>
      <div th:replace="~{pages/menu-items/delete :: deleteMenuModal}"></div>
    </div>

    <!-- Scripts -->
    <script layout:fragment="others-js">
      function prepareEditMenu(id, name, category, price, description, preparationTime, calories, isAvailable) {
        // Set semua field
        document.getElementById("editMenuId").value = id;
        document.getElementById("editMenuName").value = name;
        document.getElementById("editMenuCategory").value = category;
        document.getElementById("editMenuPrice").value = price;
        document.getElementById("editMenuDescription").value = description || '';
        document.getElementById("editMenuPreparationTime").value = preparationTime;
        document.getElementById("editMenuCalories").value = (calories !== null && calories !== 'null' && calories !== '') ? calories : '';
        document.getElementById("editMenuIsAvailable").value = isAvailable ? "true" : "false";

        // Show modal
        var editModal = new bootstrap.Modal(document.getElementById("editMenuModal"));
        editModal.show();
      }

      function prepareDeleteMenu(id, name) {
        document.getElementById("deleteMenuId").value = id;
        document.getElementById("deleteMenuName").innerText = name;

        var deleteModal = new bootstrap.Modal(document.getElementById("deleteMenuModal"));
        deleteModal.show();
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Auto-open modals jika ada error
        var addMenuModalOpen = "[[${addMenuModalOpen}]]" === "true";
        if (addMenuModalOpen) {
          var addModal = new bootstrap.Modal(document.getElementById("addMenuModal"));
          addModal.show();
        }

        var editMenuModalOpen = "[[${editMenuModalOpen}]]" === "true";
        if (editMenuModalOpen) {
          const editMenuModalId = "[[${editMenuModalId}]]";
          const buttonEdit = document.getElementById(`editMenuButton_${editMenuModalId}`);
          if (buttonEdit) {
            buttonEdit.click();
          }
        }

        var deleteMenuModalOpen = "[[${deleteMenuModalOpen}]]" === "true";
        if (deleteMenuModalOpen) {
          const deleteMenuModalId = "[[${deleteMenuModalId}]]";
          const buttonDelete = document.getElementById(`deleteMenuButton_${deleteMenuModalId}`);
          if (buttonDelete) {
            buttonDelete.click();
          }
        }
      });
    </script>
  </body>
</html>